# Ch6 文件系统实现说明

## 实现的功能

### 1. sys_fstat - 文件状态查询

**系统调用原型**：
```rust
pub fn sys_fstat(fd: usize, st: *mut Stat) -> isize
```

**功能**：获取文件描述符对应文件的状态信息

**实现步骤**：
1. 验证文件描述符有效性（fd < fd_table.len()）
2. 从文件描述符表获取文件对象
3. 调用文件对象的 `fstat()` 方法获取 Stat 结构
4. 使用 `translated_byte_buffer` 安全地将数据复制到用户空间
5. 返回 0 表示成功，-1 表示失败

**Stat 结构**：
```rust
pub struct Stat {
    pub dev: u64,      // 设备号
    pub ino: u64,      // inode 号
    pub mode: StatMode, // 文件类型
    pub nlink: u32,    // 硬链接数
    pub pad: [u64; 7], // 保留字段
}
```

### 2. sys_linkat - 创建硬链接

**系统调用原型**：
```rust
pub fn sys_linkat(old_name: *const u8, new_name: *const u8) -> isize
```

**功能**：为 old_name 文件创建一个新的硬链接 new_name

**实现步骤**：
1. 使用 `translated_str` 从用户空间读取文件名
2. 调用 `link_file(old_name, new_name)`
3. 在 VFS 层：
   - 检查 new_name 是否已存在（不能覆盖）
   - 查找 old_name 的 inode
   - 在根目录添加新的目录项指向该 inode
   - 增加 inode 的 nlink 计数
4. 返回 0 表示成功，-1 表示失败

**硬链接特点**：
- 新旧文件名指向同一个 inode
- 修改任一文件都会影响另一个
- 只有删除所有硬链接后文件才真正被删除
- 目录不能创建硬链接（为了避免循环）

### 3. sys_unlinkat - 删除硬链接

**系统调用原型**：
```rust
pub fn sys_unlinkat(name: *const u8) -> isize
```

**功能**：删除指定的文件链接

**实现步骤**：
1. 使用 `translated_str` 从用户空间读取文件名
2. 调用 `unlink_file(name)`
3. 在 VFS 层：
   - 在根目录中查找并删除该目录项
   - 减少对应 inode 的 nlink 计数
   - 如果 nlink 变为 0，文件数据会被释放
4. 返回 0 表示成功，-1 表示失败

**注意事项**：
- 删除最后一个链接时，文件数据才被真正删除
- 已打开的文件描述符仍然有效，直到关闭

## 核心数据结构修改

### DiskInode 添加 nlink 字段

```rust
pub struct DiskInode {
    pub size: u32,
    pub direct: [u32; INODE_DIRECT_COUNT],
    pub indirect1: u32,
    pub indirect2: u32,
    type_: DiskInodeType,
    pub nlink: u32,  // 新增：硬链接计数
}
```

**初始化**：
- 创建文件/目录时 nlink = 1
- 每次 link 操作 nlink += 1
- 每次 unlink 操作 nlink -= 1
- nlink = 0 时释放磁盘空间

## VFS 层新增方法

### 1. get_inode_id()
```rust
pub fn get_inode_id(&self) -> (u32, usize)
```
返回 inode 的唯一标识（block_id, block_offset）

### 2. get_disk_inode_info()
```rust
pub fn get_disk_inode_info(&self) -> (u32, u64, u32)
```
返回 (nlink, size, mode)

### 3. link()
```rust
pub fn link(&self, old_name: &str, new_name: &str) -> isize
```
在当前目录创建硬链接

### 4. unlink()
```rust
pub fn unlink(&self, name: &str) -> isize
```
删除指定的目录项

### 5. inc_nlink() / dec_nlink()
```rust
pub fn inc_nlink(&self)
pub fn dec_nlink(&self)
```
增加/减少链接计数

## 测试方法

### 1. 编译运行
```bash
cd /home/coder/workspace/os
make run
```

### 2. 测试命令
在 QEMU 中：
```bash
fstat      # 测试文件状态查询
link       # 测试硬链接创建
unlink     # 测试硬链接删除
```

### 3. 预期结果
- 所有测试程序正常退出（exit code 0）
- 显示 "ch6 Usertests passed!" 消息

## 可能遇到的问题

### 1. 输出不显示
**原因**：Ch6 的 spawn 实现不支持输出重定向，子进程输出看不到
**解决**：这是正常现象，通过退出码判断成功

### 2. nlink 计数错误
**原因**：link/unlink 操作未正确更新计数
**检查**：确保每次操作都调用 inc_nlink/dec_nlink

### 3. 文件未删除
**原因**：nlink > 0 时文件不会被删除
**检查**：确认所有硬链接都已删除

## 性能优化

1. **缓存机制**：利用 block_cache 减少磁盘访问
2. **批量操作**：目录操作尽量合并
3. **延迟删除**：nlink = 0 时可以延迟删除数据块

## 扩展思考

1. **符号链接 vs 硬链接**
   - 符号链接是独立的文件，存储目标路径
   - 硬链接共享 inode，更高效但有限制

2. **跨文件系统链接**
   - 硬链接不能跨文件系统（inode 号唯一性）
   - 符号链接可以跨文件系统

3. **目录的硬链接**
   - 通常禁止目录硬链接（避免循环）
   - 只有 "." 和 ".." 是特殊的目录链接

## 相关资源

- rCore 官方教程：https://LearningOS.github.io/rCore-Tutorial-Guide/
- Ch6 文件系统章节：第六章
- easy-fs 文件系统实现：easy-fs/ 目录
