# rCore ç¬¬ä¸‰ç« æµ‹è¯•å®ç°

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬ä»“åº“åŒ…å« rCore-Tutorial ç¬¬ä¸‰ç« ç»ƒä¹ çš„å®Œæ•´å®ç°ï¼Œé‡ç‚¹æ˜¯ `sys_trace` ç³»ç»Ÿè°ƒç”¨å’Œç³»ç»Ÿè°ƒç”¨è®¡æ•°æœºåˆ¶ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### 1. ç³»ç»Ÿè°ƒç”¨è¿½è¸ªï¼ˆ`sys_trace`ï¼‰

å®ç°äº†ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„è°ƒè¯•ç³»ç»Ÿè°ƒç”¨ï¼Œæ”¯æŒä¸‰ç§æ“ä½œï¼š

- **è¯»å–æ“ä½œ**ï¼ˆ`TraceRequest::Read = 0`ï¼‰
  - ä»æŒ‡å®šå†…å­˜åœ°å€è¯»å–ä¸€ä¸ªå­—èŠ‚
  - æˆåŠŸè¿”å›å­—èŠ‚å€¼ï¼Œå¤±è´¥è¿”å› -1

- **å†™å…¥æ“ä½œ**ï¼ˆ`TraceRequest::Write = 1`ï¼‰
  - å‘æŒ‡å®šå†…å­˜åœ°å€å†™å…¥ä¸€ä¸ªå­—èŠ‚
  - æˆåŠŸè¿”å› 0ï¼Œå¤±è´¥è¿”å› -1

- **ç³»ç»Ÿè°ƒç”¨è®¡æ•°**ï¼ˆ`TraceRequest::Syscall = 2`ï¼‰
  - è¿½è¸ªæ¯ä¸ªç³»ç»Ÿè°ƒç”¨è¢«è°ƒç”¨çš„æ¬¡æ•°
  - è¿”å›æŒ‡å®šç³»ç»Ÿè°ƒç”¨ ID çš„è°ƒç”¨æ¬¡æ•°

### 2. è‡ªåŠ¨ç³»ç»Ÿè°ƒç”¨è®¡æ•°å™¨

- æ¯ä¸ªä»»åŠ¡ç»´æŠ¤ä¸€ä¸ªè®¡æ•°å™¨æ•°ç»„ï¼Œè¿½è¸ªæ‰€æœ‰ç³»ç»Ÿè°ƒç”¨
- æ¯æ¬¡ç³»ç»Ÿè°ƒç”¨æ—¶è‡ªåŠ¨é€’å¢è®¡æ•°å™¨
- æ”¯æŒæœ€å¤š 500 ä¸ªä¸åŒçš„ç³»ç»Ÿè°ƒç”¨ ID

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### `os/src/task/task.rs`
```rust
// åœ¨ TaskControlBlock ä¸­æ·»åŠ ç³»ç»Ÿè°ƒç”¨è®¡æ•°å™¨
pub struct TaskControlBlock {
    pub task_status: TaskStatus,
    pub task_cx: TaskContext,
    pub syscall_times: [u32; MAX_SYSCALL_NUM],  // â† æ–°å¢å­—æ®µ
}
```

### `os/src/task/mod.rs`
```rust
// æ·»åŠ ç³»ç»Ÿè°ƒç”¨è®¡æ•°çš„è¾…åŠ©å‡½æ•°
pub fn increase_syscall_times(syscall_id: usize);  // å¢åŠ è®¡æ•°
pub fn get_syscall_times(syscall_id: usize) -> u32; // æŸ¥è¯¢è®¡æ•°
```

### `os/src/syscall/mod.rs`
```rust
// æ¯æ¬¡ç³»ç»Ÿè°ƒç”¨æ—¶è‡ªåŠ¨è®¡æ•°
pub fn syscall(syscall_id: usize, args: [usize; 3]) -> isize {
    increase_syscall_times(syscall_id);  // â† è‡ªåŠ¨é€’å¢
    // ... åˆ†å‘ç³»ç»Ÿè°ƒç”¨
}
```

### `os/src/syscall/process.rs`
```rust
// å®Œæ•´å®ç° sys_trace ç³»ç»Ÿè°ƒç”¨
pub fn sys_trace(trace_request: usize, id: usize, data: usize) -> isize {
    match trace_request {
        0 => { /* ä»å†…å­˜è¯»å–å­—èŠ‚ */ }
        1 => { /* å‘å†…å­˜å†™å…¥å­—èŠ‚ */ }
        2 => { /* è¿”å›ç³»ç»Ÿè°ƒç”¨è®¡æ•° */ }
        _ => -1,
    }
}
```

## ğŸ§ª æµ‹è¯•ç»“æœ

æ‰€æœ‰ 7 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼š

```
âœ“ get_time OK
âœ“ Test sleep OK
âœ“ current time_msec
âœ“ time_msec after sleeping
âœ“ Test sleep1 passed
âœ“ string from task trace test
âœ“ Test trace OK

æµ‹è¯•é€šè¿‡ï¼š7/7
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### è¿è¡Œæµ‹è¯•

```bash
# è¿›å…¥ rCore-Tutorial-Code ç›®å½•
cd /path/to/rCore-Tutorial-Code
git checkout ch3

# è®¾ç½®æµ‹è¯•ç¯å¢ƒ
rm -rf ci-user
git clone https://github.com/LearningOS/rCore-Tutorial-Checker.git ci-user
git clone https://github.com/LearningOS/rCore-Tutorial-Test.git ci-user/user

# è¿è¡Œç¬¬ä¸‰ç« æµ‹è¯•
cd ci-user
make test CHAPTER=3
```

### åœ¨ç”¨æˆ·ç¨‹åºä¸­ä½¿ç”¨ sys_trace

```rust
use user_lib::{trace_read, trace_write, count_syscall, SYSCALL_WRITE};

// ä»å†…å­˜è¯»å–å­—èŠ‚
let var = 42u8;
if let Some(value) = trace_read(&var as *const u8) {
    println!("è¯»å–åˆ°çš„å€¼: {}", value);
}

// å‘å†…å­˜å†™å…¥å­—èŠ‚
trace_write(&var as *const u8, 100);

// è·å–ç³»ç»Ÿè°ƒç”¨è®¡æ•°
let write_count = count_syscall(SYSCALL_WRITE);
println!("WRITE ç³»ç»Ÿè°ƒç”¨è¢«è°ƒç”¨äº† {} æ¬¡", write_count);
```

## ğŸ—ï¸ å®ç°ç»†èŠ‚

### å†…å­˜è®¿é—®å®‰å…¨

å½“å‰å®ç°ç›´æ¥è®¿é—®å†…å­˜åœ°å€è¿›è¡Œè¯»å†™æ“ä½œã€‚åœ¨ç”Ÿäº§ç¯å¢ƒçš„æ“ä½œç³»ç»Ÿä¸­ï¼Œåº”è¯¥åŒ…æ‹¬ï¼š
- è™šæ‹Ÿåœ°å€éªŒè¯
- é¡µè¡¨æ£€æŸ¥
- ç”¨æˆ·/å†…æ ¸ç©ºé—´è¾¹ç•ŒéªŒè¯
- å†…å­˜è®¿é—®æƒé™æ£€æŸ¥

### ç³»ç»Ÿè°ƒç”¨è®¡æ•°å™¨è®¾è®¡

- **å­˜å‚¨æ–¹å¼**ï¼šæ¯ä¸ªä»»åŠ¡ç»´æŠ¤ 500 ä¸ª u32 è®¡æ•°å™¨çš„æ•°ç»„
- **å†…å­˜å¼€é”€**ï¼šæ¯ä¸ªä»»åŠ¡çº¦ 2KBï¼ˆ500 Ã— 4 å­—èŠ‚ï¼‰
- **çº¿ç¨‹å®‰å…¨**ï¼šé€šè¿‡ TaskManager çš„äº’æ–¥è®¿é—®é”ä¿æŠ¤
- **æ€§èƒ½**ï¼šO(1) çš„é€’å¢å’ŒæŸ¥è¯¢æ“ä½œ

### ç³»ç»Ÿè°ƒç”¨æµç¨‹

```
ç”¨æˆ·ç¨‹åº
    â†“
sys_trace(request, id, data)
    â†“
syscall(SYSCALL_TRACE, [request, id, data])
    â†“
increase_syscall_times(SYSCALL_TRACE)  â† è®¡æ•°å™¨++
    â†“
match request {
    0 => è¯»å–å†…å­˜
    1 => å†™å…¥å†…å­˜
    2 => get_syscall_times(id)
}
```

## ğŸ“š API å‚è€ƒ

### ç”¨æˆ·ç©ºé—´å‡½æ•°

```rust
// ä»åœ°å€è¯»å–ä¸€ä¸ªå­—èŠ‚
pub fn trace_read(addr: *const u8) -> Option<u8>;

// å‘åœ°å€å†™å…¥ä¸€ä¸ªå­—èŠ‚
pub fn trace_write(addr: *const u8, data: u8) -> isize;

// è·å–ç³»ç»Ÿè°ƒç”¨çš„è°ƒç”¨æ¬¡æ•°
pub fn count_syscall(syscall_id: usize) -> isize;
```

### å†…æ ¸ç©ºé—´å‡½æ•°

```rust
// å¢åŠ å½“å‰ä»»åŠ¡çš„ç³»ç»Ÿè°ƒç”¨è®¡æ•°
pub fn increase_syscall_times(syscall_id: usize);

// è·å–å½“å‰ä»»åŠ¡çš„ç³»ç»Ÿè°ƒç”¨è®¡æ•°
pub fn get_syscall_times(syscall_id: usize) -> u32;

// sys_trace ç³»ç»Ÿè°ƒç”¨çš„ä¸»è¦å®ç°
pub fn sys_trace(trace_request: usize, id: usize, data: usize) -> isize;
```

## ğŸ” è°ƒè¯•æŠ€å·§

### å¯ç”¨è·Ÿè¸ªæ—¥å¿—

å®ç°ä¸­åŒ…å«äº†è·Ÿè¸ªçº§åˆ«çš„æ—¥å¿—ï¼š
```rust
trace!("kernel: sys_trace request={} id={} data={}", trace_request, id, data);
```

é€šè¿‡ LOG ç¯å¢ƒå˜é‡å¯ç”¨ï¼š
```bash
LOG=trace make run
```

### å¸¸è§é—®é¢˜

1. **æ— æ•ˆçš„å†…å­˜è®¿é—®**ï¼šåœ¨ trace_read/write ä¹‹å‰ç¡®ä¿åœ°å€æœ‰æ•ˆ
2. **è®¡æ•°å™¨æº¢å‡º**ï¼šu32 è®¡æ•°å™¨æœ€å¤šå¯ä»¥è®°å½• 4,294,967,295 æ¬¡è°ƒç”¨
3. **ç³»ç»Ÿè°ƒç”¨ ID èŒƒå›´**ï¼šåªæœ‰ ID < 500 çš„ç³»ç»Ÿè°ƒç”¨ä¼šè¢«è®¡æ•°

## ğŸ“– å‚è€ƒèµ„æ–™

- [rCore æ•™ç¨‹æŒ‡å—](https://LearningOS.github.io/rCore-Tutorial-Guide/)
- [rCore æ•™ç¨‹ä¹¦ v3](https://rcore-os.github.io/rCore-Tutorial-Book-v3/)
- [ç¬¬ä¸‰ç«  OS API æ–‡æ¡£](https://learningos.github.io/rCore-Tutorial-Code/ch3/os/index.html)

## ğŸ¯ å­¦ä¹ æˆæœ

é€šè¿‡å®Œæˆæœ¬ç« èŠ‚ï¼Œä½ å°†ç†è§£ï¼š

- âœ… ç³»ç»Ÿè°ƒç”¨çš„å®ç°å’Œåˆ†å‘æœºåˆ¶
- âœ… ä»»åŠ¡æ§åˆ¶å—çš„ç»“æ„å’Œç®¡ç†
- âœ… å†…æ ¸ç©ºé—´çš„å†…å­˜è®¿é—®æ¨¡å¼
- âœ… ä½¿ç”¨è·Ÿè¸ªæœºåˆ¶è¿›è¡Œè°ƒè¯•çš„æŠ€æœ¯
- âœ… é€šè¿‡ç³»ç»Ÿè°ƒç”¨è®¡æ•°è¿›è¡Œæ€§èƒ½ç›‘æ§

## ğŸ’¡ è®¾è®¡äº®ç‚¹

### 1. æœ€å°ä¾µå…¥æ€§è®¾è®¡
åªåœ¨ `TaskControlBlock` ä¸­æ·»åŠ ä¸€ä¸ªæ•°ç»„å­—æ®µï¼Œå¯¹ç°æœ‰ä»£ç å½±å“æœ€å°ã€‚

### 2. è‡ªåŠ¨åŒ–è®¡æ•°
åœ¨ç³»ç»Ÿè°ƒç”¨å…¥å£å¤„ç»Ÿä¸€å¤„ç†è®¡æ•°ï¼Œæ— éœ€åœ¨æ¯ä¸ªç³»ç»Ÿè°ƒç”¨ä¸­é‡å¤æ·»åŠ ä»£ç ã€‚

### 3. çµæ´»çš„è¿½è¸ªæœºåˆ¶
`sys_trace` æ”¯æŒä¸‰ç§ä¸åŒçš„æ“ä½œï¼Œå¯ä»¥çµæ´»ç”¨äºä¸åŒçš„è°ƒè¯•åœºæ™¯ã€‚

### 4. é«˜æ•ˆçš„æŸ¥è¯¢
ä½¿ç”¨æ•°ç»„ç´¢å¼•ç›´æ¥è®¿é—®è®¡æ•°å™¨ï¼ŒæŸ¥è¯¢å’Œæ›´æ–°éƒ½æ˜¯ O(1) å¤æ‚åº¦ã€‚

## ğŸ”§ å¯èƒ½çš„æ”¹è¿›æ–¹å‘

1. **å†…å­˜è®¿é—®å®‰å…¨**
   - æ·»åŠ åœ°å€èŒƒå›´æ£€æŸ¥
   - å®ç°ç”¨æˆ·ç©ºé—´åœ°å€éªŒè¯
   - æ·»åŠ é¡µè¡¨æƒé™æ£€æŸ¥

2. **è®¡æ•°å™¨ä¼˜åŒ–**
   - ä½¿ç”¨ç¨€ç–æ•°ç»„å‡å°‘å†…å­˜å ç”¨
   - å®ç°è®¡æ•°å™¨æº¢å‡ºä¿æŠ¤
   - æ·»åŠ è®¡æ•°å™¨é‡ç½®åŠŸèƒ½

3. **åŠŸèƒ½æ‰©å±•**
   - æ”¯æŒè¯»å†™å¤šä¸ªå­—èŠ‚
   - æ·»åŠ ç³»ç»Ÿè°ƒç”¨è€—æ—¶ç»Ÿè®¡
   - å®ç°ç³»ç»Ÿè°ƒç”¨è¿½è¸ªæ—¥å¿—

## ğŸ¤ è´¡çŒ®

æœ¬å®ç°æ˜¯ rCore-Tutorial å­¦ä¹ ææ–™çš„ä¸€éƒ¨åˆ†ã€‚å¦‚æœ‰é—®é¢˜æˆ–æ”¹è¿›å»ºè®®ï¼š

1. æŸ¥é˜…[å®˜æ–¹æ•™ç¨‹](https://LearningOS.github.io/rCore-Tutorial-Guide/)
2. æŸ¥çœ‹ `rCore-Tutorial-Test` ä»“åº“ä¸­çš„æµ‹è¯•ç”¨ä¾‹
3. å‚ä¸ rCore ç¤¾åŒºè®ºå›è®¨è®º

## ğŸ“Š æ€§èƒ½åˆ†æ

### å†…å­˜å¼€é”€
- æ¯ä¸ªä»»åŠ¡å¢åŠ ï¼š2000 å­—èŠ‚ï¼ˆ500 Ã— u32ï¼‰
- 16 ä¸ªä»»åŠ¡æ€»å¼€é”€ï¼šçº¦ 32KB
- å¯¹äºæ•™å­¦ç›®çš„ï¼Œå¼€é”€å¯æ¥å—

### æ—¶é—´å¼€é”€
- ç³»ç»Ÿè°ƒç”¨è®¡æ•°ï¼š1 æ¬¡æ•°ç»„è®¿é—® + 1 æ¬¡é€’å¢æ“ä½œ
- è®¡æ•°æŸ¥è¯¢ï¼š1 æ¬¡æ•°ç»„è®¿é—®
- æ€»ä½“å½±å“ï¼šå¯å¿½ç•¥ä¸è®¡

## ğŸ“„ è®¸å¯è¯

æœ¬ä»£ç éµå¾ªä¸ rCore-Tutorial-Code ç›¸åŒçš„è®¸å¯è¯ã€‚

---

**å®ç°æ—¥æœŸ**ï¼š2024å¹´2æœˆ
**rCore ç‰ˆæœ¬**ï¼šåŸºäº ch3 åˆ†æ”¯
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ7/7ï¼‰
**ä½œè€…**ï¼šåŸºäº rCore-Tutorial çš„å­¦ä¹ å®ç°
