# rCore Ch3 æµ‹è¯•ä»£ç é€è¡Œè§£è¯»

## ğŸ“š ç›®å½•

1. [os/src/task/task.rs - ä»»åŠ¡æ§åˆ¶å—](#1-ä»»åŠ¡æ§åˆ¶å—)
2. [os/src/task/mod.rs - ä»»åŠ¡ç®¡ç†å™¨](#2-ä»»åŠ¡ç®¡ç†å™¨)
3. [os/src/syscall/mod.rs - ç³»ç»Ÿè°ƒç”¨åˆ†å‘](#3-ç³»ç»Ÿè°ƒç”¨åˆ†å‘)
4. [os/src/syscall/process.rs - sys_trace å®ç°](#4-sys_trace-å®ç°)

---

## 1. ä»»åŠ¡æ§åˆ¶å—

### æ–‡ä»¶ï¼š`os/src/task/task.rs`

```rust
//! Types related to task management
```
**è¯´æ˜**ï¼šè¿™æ˜¯æ–‡æ¡£æ³¨é‡Šï¼Œè¯´æ˜è¿™ä¸ªæ¨¡å—åŒ…å«ä»»åŠ¡ç®¡ç†ç›¸å…³çš„ç±»å‹å®šä¹‰ã€‚

```rust
use super::TaskContext;
```
**è¯´æ˜**ï¼šå¯¼å…¥çˆ¶æ¨¡å—ä¸­çš„ `TaskContext` ç±»å‹ï¼Œè¿™æ˜¯ä¿å­˜ä»»åŠ¡ä¸Šä¸‹æ–‡ï¼ˆå¯„å­˜å™¨çŠ¶æ€ï¼‰çš„ç»“æ„ä½“ã€‚

```rust
/// The maximum number of syscalls that can be traced (covers up to syscall 500)
const MAX_SYSCALL_NUM: usize = 500;
```
**è¯´æ˜**ï¼š
- å®šä¹‰å¸¸é‡ï¼šæœ€å¤§å¯è¿½è¸ªçš„ç³»ç»Ÿè°ƒç”¨æ•°é‡ä¸º 500
- ä¸ºä»€ä¹ˆæ˜¯ 500ï¼Ÿå› ä¸º rCore çš„ç³»ç»Ÿè°ƒç”¨ ID æœ€å¤§åˆ° 470 å·¦å³ï¼Œ500 è¶³å¤Ÿè¦†ç›–æ‰€æœ‰å¯èƒ½çš„ç³»ç»Ÿè°ƒç”¨
- è¿™ä¸ªå¸¸é‡ç”¨äºå®šä¹‰è®¡æ•°å™¨æ•°ç»„çš„å¤§å°

```rust
/// The task control block (TCB) of a task.
#[derive(Copy, Clone)]
pub struct TaskControlBlock {
```
**è¯´æ˜**ï¼š
- **ä»»åŠ¡æ§åˆ¶å—ï¼ˆTCBï¼‰**ï¼šæ“ä½œç³»ç»Ÿä¸­è¡¨ç¤ºä¸€ä¸ªä»»åŠ¡çš„æ ¸å¿ƒæ•°æ®ç»“æ„
- `#[derive(Copy, Clone)]`ï¼šè‡ªåŠ¨å®ç° Copy å’Œ Clone traitï¼Œå…è®¸è¿™ä¸ªç»“æ„ä½“è¢«å¤åˆ¶
- `pub`ï¼šå…¬å¼€å¯è§ï¼Œå…¶ä»–æ¨¡å—å¯ä»¥ä½¿ç”¨

```rust
    /// The task status in it's lifecycle
    pub task_status: TaskStatus,
```
**è¯´æ˜**ï¼š
- ä»»åŠ¡çŠ¶æ€ï¼šè®°å½•ä»»åŠ¡å½“å‰çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€
- å¯èƒ½çš„å€¼ï¼šUnInitï¼ˆæœªåˆå§‹åŒ–ï¼‰ã€Readyï¼ˆå°±ç»ªï¼‰ã€Runningï¼ˆè¿è¡Œä¸­ï¼‰ã€Exitedï¼ˆå·²é€€å‡ºï¼‰

```rust
    /// The task context
    pub task_cx: TaskContext,
```
**è¯´æ˜**ï¼š
- ä»»åŠ¡ä¸Šä¸‹æ–‡ï¼šä¿å­˜ä»»åŠ¡çš„å¯„å­˜å™¨çŠ¶æ€
- å½“ä»»åŠ¡åˆ‡æ¢æ—¶ï¼Œéœ€è¦ä¿å­˜/æ¢å¤è¿™äº›å¯„å­˜å™¨çš„å€¼
- åŒ…æ‹¬é€šç”¨å¯„å­˜å™¨ã€ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰ã€æ ˆæŒ‡é’ˆï¼ˆSPï¼‰ç­‰

```rust
    /// Syscall times counter
    pub syscall_times: [u32; MAX_SYSCALL_NUM],
}
```
**è¯´æ˜**ï¼š
- **æ–°å¢å­—æ®µ**ï¼šç³»ç»Ÿè°ƒç”¨è®¡æ•°å™¨æ•°ç»„
- ç±»å‹ï¼š`[u32; 500]` - 500 ä¸ª 32 ä½æ— ç¬¦å·æ•´æ•°
- ç”¨é€”ï¼š`syscall_times[i]` è®°å½•ç³»ç»Ÿè°ƒç”¨ ID ä¸º i çš„è°ƒç”¨æ¬¡æ•°
- å†…å­˜å ç”¨ï¼š500 Ã— 4 å­—èŠ‚ = 2000 å­—èŠ‚ï¼ˆ2KBï¼‰

```rust
/// The status of a task
#[derive(Copy, Clone, PartialEq)]
pub enum TaskStatus {
    /// uninitialized
    UnInit,
    /// ready to run
    Ready,
    /// running
    Running,
    /// exited
    Exited,
}
```
**è¯´æ˜**ï¼š
- ä»»åŠ¡çŠ¶æ€æšä¸¾ç±»å‹
- `PartialEq`ï¼šå…è®¸çŠ¶æ€ä¹‹é—´è¿›è¡Œç›¸ç­‰æ¯”è¾ƒ
- **çŠ¶æ€è½¬æ¢**ï¼šUnInit â†’ Ready â†’ Running â‡„ Ready â†’ Exited

---

## 2. ä»»åŠ¡ç®¡ç†å™¨

### æ–‡ä»¶ï¼š`os/src/task/mod.rs`ï¼ˆå…³é”®éƒ¨åˆ†ï¼‰

#### 2.1 ä»»åŠ¡åˆå§‹åŒ–

```rust
lazy_static! {
    /// Global variable: TASK_MANAGER
    pub static ref TASK_MANAGER: TaskManager = {
```
**è¯´æ˜**ï¼š
- `lazy_static!`ï¼šå»¶è¿Ÿåˆå§‹åŒ–çš„é™æ€å˜é‡ï¼Œç¬¬ä¸€æ¬¡è®¿é—®æ—¶æ‰åˆå§‹åŒ–
- `TASK_MANAGER`ï¼šå…¨å±€ä»»åŠ¡ç®¡ç†å™¨ï¼Œç®¡ç†æ‰€æœ‰ä»»åŠ¡

```rust
        let num_app = get_num_app();
```
**è¯´æ˜**ï¼šè·å–è¦è¿è¡Œçš„åº”ç”¨ç¨‹åºæ•°é‡

```rust
        let mut tasks = [TaskControlBlock {
            task_cx: TaskContext::zero_init(),
            task_status: TaskStatus::UnInit,
            syscall_times: [0; 500],  // â† å…³é”®ï¼šåˆå§‹åŒ–è®¡æ•°å™¨
        }; MAX_APP_NUM];
```
**è¯´æ˜**ï¼š
- åˆ›å»ºä»»åŠ¡æ§åˆ¶å—æ•°ç»„ï¼Œæ•°é‡ä¸º `MAX_APP_NUM`ï¼ˆæœ€å¤§åº”ç”¨æ•°é‡ï¼‰
- **åˆå§‹åŒ–æ¯ä¸ªå­—æ®µ**ï¼š
  - `task_cx`ï¼šä¸Šä¸‹æ–‡åˆå§‹åŒ–ä¸º 0
  - `task_status`ï¼šçŠ¶æ€è®¾ä¸ºæœªåˆå§‹åŒ–
  - `syscall_times`ï¼š**æ‰€æœ‰è®¡æ•°å™¨åˆå§‹åŒ–ä¸º 0**
- `[0; 500]`ï¼šåˆ›å»º 500 ä¸ªå…ƒç´ ï¼Œæ¯ä¸ªéƒ½æ˜¯ 0

#### 2.2 å¢åŠ ç³»ç»Ÿè°ƒç”¨è®¡æ•°

```rust
/// Increase the syscall times of current task
pub fn increase_syscall_times(syscall_id: usize) {
```
**è¯´æ˜**ï¼š
- åŠŸèƒ½ï¼šå¢åŠ å½“å‰ä»»åŠ¡çš„ç³»ç»Ÿè°ƒç”¨è®¡æ•°
- å‚æ•°ï¼š`syscall_id` - ç³»ç»Ÿè°ƒç”¨çš„ ID

```rust
    let mut inner = TASK_MANAGER.inner.exclusive_access();
```
**è¯´æ˜**ï¼š
- è·å–ä»»åŠ¡ç®¡ç†å™¨çš„ç‹¬å è®¿é—®æƒ
- `exclusive_access()`ï¼šç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªåœ°æ–¹èƒ½ä¿®æ”¹ä»»åŠ¡ç®¡ç†å™¨
- **çº¿ç¨‹å®‰å…¨**ï¼šé˜²æ­¢å¤šä¸ª CPU æ ¸å¿ƒåŒæ—¶ä¿®æ”¹å¯¼è‡´æ•°æ®ç«äº‰

```rust
    let current = inner.current_task;
```
**è¯´æ˜**ï¼š
- è·å–å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ ID
- `current_task` æ˜¯ä¸€ä¸ªç´¢å¼•ï¼ŒæŒ‡å‘ tasks æ•°ç»„ä¸­çš„æŸä¸ªä»»åŠ¡

```rust
    if syscall_id < 500 {
```
**è¯´æ˜**ï¼š
- **è¾¹ç•Œæ£€æŸ¥**ï¼šåªæœ‰ ID < 500 çš„ç³»ç»Ÿè°ƒç”¨æ‰è®¡æ•°
- é˜²æ­¢æ•°ç»„è¶Šç•Œè®¿é—®

```rust
        inner.tasks[current].syscall_times[syscall_id] += 1;
    }
}
```
**è¯´æ˜**ï¼š
- æ‰¾åˆ°å½“å‰ä»»åŠ¡ï¼š`inner.tasks[current]`
- æ‰¾åˆ°å¯¹åº”çš„è®¡æ•°å™¨ï¼š`syscall_times[syscall_id]`
- **åŸå­é€’å¢**ï¼š`+= 1`
- é‡Šæ”¾é”ï¼šå‡½æ•°ç»“æŸæ—¶ `inner` è¢« dropï¼Œè‡ªåŠ¨é‡Šæ”¾ç‹¬å è®¿é—®

#### 2.3 æŸ¥è¯¢ç³»ç»Ÿè°ƒç”¨è®¡æ•°

```rust
/// Get the syscall times of current task
pub fn get_syscall_times(syscall_id: usize) -> u32 {
```
**è¯´æ˜**ï¼š
- åŠŸèƒ½ï¼šæŸ¥è¯¢å½“å‰ä»»åŠ¡çš„ç³»ç»Ÿè°ƒç”¨è®¡æ•°
- è¿”å›å€¼ï¼š`u32` - è°ƒç”¨æ¬¡æ•°

```rust
    let inner = TASK_MANAGER.inner.exclusive_access();
```
**è¯´æ˜**ï¼šè·å–ç‹¬å è®¿é—®ï¼ˆåªè¯»ä¹Ÿéœ€è¦ï¼Œä¿è¯ä¸€è‡´æ€§ï¼‰

```rust
    let current = inner.current_task;
```
**è¯´æ˜**ï¼šè·å–å½“å‰ä»»åŠ¡ ID

```rust
    if syscall_id < 500 {
        inner.tasks[current].syscall_times[syscall_id]
    } else {
        0
    }
}
```
**è¯´æ˜**ï¼š
- å¦‚æœ ID æœ‰æ•ˆï¼šè¿”å›å®é™…è®¡æ•°å€¼
- å¦‚æœ ID æ— æ•ˆï¼ˆâ‰¥500ï¼‰ï¼šè¿”å› 0
- **å®‰å…¨ä¿æŠ¤**ï¼šå³ä½¿ä¼ å…¥éæ³• ID ä¹Ÿä¸ä¼šå´©æºƒ

---

## 3. ç³»ç»Ÿè°ƒç”¨åˆ†å‘

### æ–‡ä»¶ï¼š`os/src/syscall/mod.rs`

```rust
/// trace syscall
const SYSCALL_TRACE: usize = 410;
```
**è¯´æ˜**ï¼š
- å®šä¹‰ `sys_trace` ç³»ç»Ÿè°ƒç”¨çš„ ID
- 410 æ˜¯ rCore ä¸­ä¸º trace åˆ†é…çš„ç¼–å·

```rust
use crate::task::increase_syscall_times;
```
**è¯´æ˜**ï¼šå¯¼å…¥åˆšæ‰å®ç°çš„é€’å¢å‡½æ•°

```rust
/// handle syscall exception with `syscall_id` and other arguments
pub fn syscall(syscall_id: usize, args: [usize; 3]) -> isize {
```
**è¯´æ˜**ï¼š
- **ç³»ç»Ÿè°ƒç”¨ç»Ÿä¸€å…¥å£**ï¼šæ‰€æœ‰ç³»ç»Ÿè°ƒç”¨éƒ½é€šè¿‡è¿™ä¸ªå‡½æ•°
- å‚æ•°ï¼š
  - `syscall_id`ï¼šç³»ç»Ÿè°ƒç”¨ç¼–å·
  - `args`ï¼š3 ä¸ªå‚æ•°ï¼ˆè¶³å¤Ÿä¼ é€’å¤§éƒ¨åˆ†ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ï¼‰
- è¿”å›å€¼ï¼š`isize` - ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼

```rust
    // Increase the syscall counter before executing the syscall
    increase_syscall_times(syscall_id);
```
**è¯´æ˜**ï¼š
- **å…³é”®ä¸€è¡Œ**ï¼šåœ¨æ‰§è¡Œä»»ä½•ç³»ç»Ÿè°ƒç”¨ä¹‹å‰ï¼Œå…ˆå¢åŠ è®¡æ•°
- ä¸ºä»€ä¹ˆåœ¨è¿™é‡Œï¼Ÿ
  - âœ… ç»Ÿä¸€å¤„ç†ï¼šæ‰€æœ‰ç³»ç»Ÿè°ƒç”¨éƒ½ä¼šè¢«è®¡æ•°ï¼Œä¸ä¼šé—æ¼
  - âœ… ä»£ç ç®€æ´ï¼šåªéœ€è¦åŠ ä¸€è¡Œï¼Œä¸ç”¨åœ¨æ¯ä¸ªç³»ç»Ÿè°ƒç”¨ä¸­é‡å¤
  - âœ… ä½ç½®æ­£ç¡®ï¼šåœ¨å®é™…æ‰§è¡Œä¹‹å‰è®¡æ•°ï¼Œå³ä½¿ç³»ç»Ÿè°ƒç”¨å¤±è´¥ä¹Ÿä¼šè¢«è®°å½•

```rust
    match syscall_id {
        SYSCALL_WRITE => sys_write(args[0], args[1] as *const u8, args[2]),
        SYSCALL_EXIT => sys_exit(args[0] as i32),
        SYSCALL_YIELD => sys_yield(),
        SYSCALL_GET_TIME => sys_get_time(args[0] as *mut TimeVal, args[1]),
        SYSCALL_TRACE => sys_trace(args[0], args[1], args[2]),
        _ => panic!("Unsupported syscall_id: {}", syscall_id),
    }
}
```
**è¯´æ˜**ï¼š
- **æ¨¡å¼åŒ¹é…**ï¼šæ ¹æ® `syscall_id` åˆ†å‘åˆ°ä¸åŒçš„ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•°
- æ¯ä¸ª case è°ƒç”¨å¯¹åº”çš„ `sys_xxx` å‡½æ•°
- `SYSCALL_TRACE`ï¼šè°ƒç”¨æˆ‘ä»¬å®ç°çš„ `sys_trace`
- æœ€åçš„ `_`ï¼šæ•è·æ‰€æœ‰æœªçŸ¥çš„ç³»ç»Ÿè°ƒç”¨ IDï¼Œè§¦å‘ panic

---

## 4. sys_trace å®ç°

### æ–‡ä»¶ï¼š`os/src/syscall/process.rs`

```rust
use crate::{
    task::{exit_current_and_run_next, suspend_current_and_run_next, get_syscall_times},
    timer::get_time_us,
};
```
**è¯´æ˜**ï¼š
- å¯¼å…¥ `get_syscall_times` å‡½æ•°ï¼Œç”¨äºæŸ¥è¯¢è®¡æ•°
- å…¶ä»–æ˜¯è¿›ç¨‹ç®¡ç†ç›¸å…³çš„å‡½æ•°

```rust
/// trace syscall for debugging
/// - trace_request: 0=Read, 1=Write, 2=Syscall
/// - id: address for Read/Write, syscall_id for Syscall
/// - data: data to write for Write operation
pub fn sys_trace(trace_request: usize, id: usize, data: usize) -> isize {
```
**è¯´æ˜**ï¼š
- **å‚æ•°è®¾è®¡**ï¼š
  - `trace_request`ï¼šæ“ä½œç±»å‹ï¼ˆ0/1/2ï¼‰
  - `id`ï¼šå¤šç”¨é€”å‚æ•°
    - æ“ä½œ 0/1ï¼šå†…å­˜åœ°å€
    - æ“ä½œ 2ï¼šç³»ç»Ÿè°ƒç”¨ ID
  - `data`ï¼šå†™å…¥çš„æ•°æ®ï¼ˆä»…æ“ä½œ 1 ä½¿ç”¨ï¼‰

```rust
    trace!("kernel: sys_trace request={} id={} data={}", trace_request, id, data);
```
**è¯´æ˜**ï¼š
- è°ƒè¯•æ—¥å¿—ï¼šè®°å½•ç³»ç»Ÿè°ƒç”¨å‚æ•°
- `trace!` æ˜¯æœ€ä½çº§åˆ«çš„æ—¥å¿—ï¼Œé»˜è®¤ä¸æ˜¾ç¤º
- å¯é€šè¿‡ `LOG=trace` ç¯å¢ƒå˜é‡å¯ç”¨

```rust
    match trace_request {
```
**è¯´æ˜**ï¼šåŒ¹é…æ“ä½œç±»å‹

#### 4.1 è¯»å–æ“ä½œï¼ˆReadï¼‰

```rust
        // TraceRequest::Read = 0
        0 => {
            // Read memory at address `id`
            // Check if address is valid (in user space)
            if id == 0 {
                return -1;
            }
```
**è¯´æ˜**ï¼š
- **ç©ºæŒ‡é’ˆæ£€æŸ¥**ï¼šåœ°å€ä¸º 0 æ˜¯éæ³•çš„ï¼ˆNULLï¼‰
- è¿”å› -1 è¡¨ç¤ºé”™è¯¯

```rust
            unsafe {
                let ptr = id as *const u8;
```
**è¯´æ˜**ï¼š
- `unsafe`ï¼šä¸å®‰å…¨ä»£ç å—ï¼Œç¼–è¯‘å™¨ä¸ä¿è¯å†…å­˜å®‰å…¨
- å°†åœ°å€ï¼ˆusizeï¼‰è½¬æ¢ä¸ºæŒ‡é’ˆï¼ˆ`*const u8`ï¼‰
- `*const u8`ï¼šæŒ‡å‘ u8ï¼ˆå­—èŠ‚ï¼‰çš„å¸¸é‡æŒ‡é’ˆ

```rust
                // Try to read the byte
                // In a real OS, we should check if the address is in user space
                // For simplicity, we just try to read it
                *ptr as isize
            }
        }
```
**è¯´æ˜**ï¼š
- `*ptr`ï¼šè§£å¼•ç”¨æŒ‡é’ˆï¼Œè¯»å–å†…å­˜ä¸­çš„å€¼
- `as isize`ï¼šå°† u8 è½¬æ¢ä¸º isize è¿”å›
- **æ³¨æ„**ï¼šå®é™… OS åº”è¯¥æ£€æŸ¥åœ°å€æ˜¯å¦åœ¨ç”¨æˆ·ç©ºé—´ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†

#### 4.2 å†™å…¥æ“ä½œï¼ˆWriteï¼‰

```rust
        // TraceRequest::Write = 1
        1 => {
            // Write data to memory at address `id`
            if id == 0 {
                return -1;
            }
```
**è¯´æ˜**ï¼šåŒæ ·è¿›è¡Œç©ºæŒ‡é’ˆæ£€æŸ¥

```rust
            unsafe {
                let ptr = id as *mut u8;
```
**è¯´æ˜**ï¼š
- `*mut u8`ï¼šæŒ‡å‘ u8 çš„**å¯å˜**æŒ‡é’ˆï¼ˆå¯ä»¥ä¿®æ”¹å†…å­˜ï¼‰
- ä¸ Read çš„åŒºåˆ«ï¼š`*const` vs `*mut`

```rust
                *ptr = data as u8;
            }
            0
        }
```
**è¯´æ˜**ï¼š
- `*ptr = ...`ï¼šè§£å¼•ç”¨å¹¶èµ‹å€¼ï¼Œä¿®æ”¹å†…å­˜
- `data as u8`ï¼šå°† usize è½¬æ¢ä¸º u8ï¼ˆå–ä½ 8 ä½ï¼‰
- è¿”å› 0 è¡¨ç¤ºæˆåŠŸ

#### 4.3 ç³»ç»Ÿè°ƒç”¨è®¡æ•°ï¼ˆSyscallï¼‰

```rust
        // TraceRequest::Syscall = 2
        2 => {
            // Return the syscall count for syscall_id `id`
            get_syscall_times(id) as isize
        }
```
**è¯´æ˜**ï¼š
- è°ƒç”¨ `get_syscall_times(id)` è·å–è®¡æ•°
- å‚æ•° `id` åœ¨è¿™é‡Œæ˜¯ç³»ç»Ÿè°ƒç”¨ ID
- `as isize`ï¼šå°† u32 è½¬æ¢ä¸º isize è¿”å›

```rust
        _ => -1,
    }
}
```
**è¯´æ˜**ï¼š
- å…¶ä»–æ“ä½œç±»å‹ï¼šè¿”å› -1 è¡¨ç¤ºä¸æ”¯æŒ
- ä¿æŠ¤æ€§ä»£ç ï¼šé¿å…æœªå®šä¹‰è¡Œä¸º

---

## 5. å®Œæ•´è°ƒç”¨æµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·ç¨‹åºè°ƒç”¨ `count_syscall(SYSCALL_WRITE)`

```
1. ç”¨æˆ·ç¨‹åºï¼šcount_syscall(SYSCALL_WRITE)
   â†“
2. user_libï¼štrace(TraceRequest::Syscall, SYSCALL_WRITE, 0)
   â†“
3. user_libï¼šsys_trace(2, 64, 0)  // SYSCALL_WRITE = 64
   â†“
4. ç”¨æˆ·æ€ â†’ å†…æ ¸æ€ï¼ˆecall æŒ‡ä»¤ï¼‰
   â†“
5. trap_handlerï¼šå¤„ç†å¼‚å¸¸ï¼Œè¯†åˆ«ä¸ºç³»ç»Ÿè°ƒç”¨
   â†“
6. syscall(410, [2, 64, 0])  // 410 = SYSCALL_TRACE
   â†“
7. increase_syscall_times(410)  // è®¡æ•° TRACE è°ƒç”¨
   â†“  tasks[current].syscall_times[410] += 1
   â†“
8. sys_trace(2, 64, 0)
   â†“
9. match 2 => get_syscall_times(64)
   â†“
10. è¿”å› tasks[current].syscall_times[64]  // WRITE çš„è®¡æ•°
    â†“
11. å†…æ ¸æ€ â†’ ç”¨æˆ·æ€ï¼ˆè¿”å›å€¼ï¼‰
    â†“
12. ç”¨æˆ·ç¨‹åºå¾—åˆ° WRITE ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°
```

---

## 6. å…³é”®è®¾è®¡ç‚¹

### 6.1 ä¸ºä»€ä¹ˆåœ¨ syscall() å…¥å£è®¡æ•°ï¼Ÿ

**ä¼˜ç‚¹**ï¼š
- âœ… **ç»Ÿä¸€å¤„ç†**ï¼šæ‰€æœ‰ç³»ç»Ÿè°ƒç”¨éƒ½ä¼šç»è¿‡è¿™é‡Œ
- âœ… **ä¸ä¼šé—æ¼**ï¼šå³ä½¿æ–°å¢ç³»ç»Ÿè°ƒç”¨ä¹Ÿä¼šè‡ªåŠ¨è®¡æ•°
- âœ… **ä»£ç ç®€æ´**ï¼šåªéœ€ä¸€è¡Œä»£ç 
- âœ… **åŒ…æ‹¬ TRACE è‡ªå·±**ï¼šsys_trace è°ƒç”¨è‡ªå·±ä¹Ÿä¼šè¢«è®¡æ•°

**ä½ç½®é€‰æ‹©**ï¼š
```rust
pub fn syscall(syscall_id: usize, args: [usize; 3]) -> isize {
    increase_syscall_times(syscall_id);  // â† åœ¨è¿™é‡Œï¼šæ‰§è¡Œå‰è®¡æ•°
    match syscall_id {
        // ... åˆ†å‘é€»è¾‘
    }
}
```

### 6.2 ä¸ºä»€ä¹ˆç”¨ u32 è€Œä¸æ˜¯ usizeï¼Ÿ

**åŸå› **ï¼š
- u32 æœ€å¤§å€¼ï¼š4,294,967,295ï¼ˆ40 å¤šäº¿ï¼‰
- å¯¹äºç³»ç»Ÿè°ƒç”¨è®¡æ•°å®Œå…¨è¶³å¤Ÿ
- èŠ‚çœå†…å­˜ï¼šåœ¨ 64 ä½ç³»ç»Ÿä¸Šï¼Œu32 å  4 å­—èŠ‚ï¼Œusize å  8 å­—èŠ‚

### 6.3 ä¸ºä»€ä¹ˆæ•°ç»„å¤§å°æ˜¯ 500ï¼Ÿ

**è€ƒè™‘å› ç´ **ï¼š
- rCore å½“å‰æœ€å¤§ç³»ç»Ÿè°ƒç”¨ ID çº¦ 470
- ç•™æœ‰ä½™åœ°ï¼š500 > 470ï¼Œæœªæ¥å¯æ‰©å±•
- å†…å­˜å¯æ¥å—ï¼š500 Ã— 4 = 2KB/ä»»åŠ¡

### 6.4 çº¿ç¨‹å®‰å…¨å¦‚ä½•ä¿è¯ï¼Ÿ

**æœºåˆ¶**ï¼š
```rust
let mut inner = TASK_MANAGER.inner.exclusive_access();
```

- `exclusive_access()`ï¼šäº’æ–¥é”ï¼ˆMutexï¼‰
- åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªåœ°æ–¹èƒ½è®¿é—®
- è‡ªåŠ¨é‡Šæ”¾ï¼šå˜é‡ drop æ—¶è§£é”

---

## 7. æµ‹è¯•ç”¨ä¾‹è§£æ

### æµ‹è¯•ä»£ç ï¼š`user/src/bin/ch3_trace.rs`

```rust
// è°ƒç”¨ get_time 3 æ¬¡
let t1 = get_time() as usize;  // syscall_times[169]++
get_time();                     // syscall_times[169]++
sleep(500);                     // å†…éƒ¨è°ƒç”¨ yield å¤šæ¬¡
let t2 = get_time() as usize;  // syscall_times[169]++
```

**éªŒè¯è®¡æ•°**ï¼š
```rust
assert!(3 <= count_syscall(SYSCALL_GETTIMEOFDAY));
// count_syscall æœ¬èº«ä¹Ÿæ˜¯ sys_trace è°ƒç”¨
// syscall_times[410]++ ï¼ˆç¬¬ä¸€æ¬¡è°ƒç”¨ traceï¼‰
```

**ä¸ºä»€ä¹ˆæ˜¯ â‰¥3ï¼Ÿ**
- æ˜ç¡®è°ƒç”¨äº† 3 æ¬¡ get_time
- sleep å¯èƒ½ä¹Ÿä¼šè°ƒç”¨ï¼ˆå®ç°ç›¸å…³ï¼‰

---

## 8. æ€»ç»“

### å®ç°çš„æ ¸å¿ƒé€»è¾‘

1. **æ•°æ®ç»“æ„**ï¼šåœ¨ TCB ä¸­æ·»åŠ è®¡æ•°å™¨æ•°ç»„
2. **è‡ªåŠ¨è®¡æ•°**ï¼šåœ¨ç³»ç»Ÿè°ƒç”¨å…¥å£ç»Ÿä¸€é€’å¢
3. **æŸ¥è¯¢æ¥å£**ï¼šæä¾›å‡½æ•°è¯»å–è®¡æ•°
4. **sys_trace**ï¼šå®ç°ä¸‰ç§æ“ä½œï¼ˆRead/Write/Syscallï¼‰

### ä»£ç é‡ç»Ÿè®¡

- æ–°å¢ä»£ç ï¼šçº¦ 70 è¡Œ
- ä¿®æ”¹ä»£ç ï¼šçº¦ 5 è¡Œ
- æ€»å…±æ¶‰åŠï¼š4 ä¸ªæ–‡ä»¶

### è®¾è®¡ä¼˜ç‚¹

- âœ… **æœ€å°ä¾µå…¥**ï¼šåªåœ¨å¿…è¦çš„åœ°æ–¹ä¿®æ”¹
- âœ… **é«˜æ•ˆå®ç°**ï¼šO(1) å¤æ‚åº¦
- âœ… **æ˜“äºç»´æŠ¤**ï¼šé€»è¾‘æ¸…æ™°ï¼Œæ³¨é‡Šå®Œæ•´
- âœ… **åŠŸèƒ½å®Œæ•´**ï¼šé€šè¿‡æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹

---

**å®Œæˆæ—¶é—´**ï¼šçº¦ 2-3 å°æ—¶ï¼ˆåŒ…æ‹¬æµ‹è¯•å’Œè°ƒè¯•ï¼‰
**éš¾åº¦è¯„çº§**ï¼šâ­â­â­â˜†â˜†ï¼ˆä¸­ç­‰ï¼‰
**å­¦ä¹ ä»·å€¼**ï¼šâ­â­â­â­â­ï¼ˆéå¸¸é«˜ï¼‰
