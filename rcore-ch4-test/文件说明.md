# Ch4 实现文件说明

## 文件列表

### 1. memory_set.rs
- **原路径**: `os/src/mm/memory_set.rs`
- **修改内容**:
  - 添加 `pub fn mmap()` 方法
  - 添加 `pub fn munmap()` 方法
- **关键实现**:
  - 虚拟内存区域的创建和销毁
  - 页表映射管理

### 2. process.rs
- **原路径**: `os/src/syscall/process.rs`
- **修改内容**:
  - 实现 `sys_get_time()` 系统调用
  - 实现 `sys_trace()` 系统调用
  - 实现 `sys_mmap()` 系统调用
  - 实现 `sys_munmap()` 系统调用
  - 添加 `safe_translate_byte_read()` 辅助函数
  - 添加 `safe_translate_byte_write()` 辅助函数

### 3. syscall_mod.rs
- **原路径**: `os/src/syscall/mod.rs`
- **修改内容**:
  - 在 `syscall()` 函数中添加新的系统调用分发
  - SYSCALL_GET_TIME
  - SYSCALL_TRACE
  - SYSCALL_MMAP
  - SYSCALL_MUNMAP

### 4. task_mod.rs
- **原路径**: `os/src/task/mod.rs`
- **修改内容**:
  - 添加全局 `pub fn mmap()` 函数
  - 添加全局 `pub fn munmap()` 函数
  - 在 `TaskManager` 中添加 `mmap()` 和 `munmap()` 方法
  - 导出 `current_user_token()` 函数

### 5. task.rs
- **原路径**: `os/src/task/task.rs`
- **修改内容**:
  - 在 `TaskControlBlock` 中添加 `pub fn mmap()` 方法
  - 在 `TaskControlBlock` 中添加 `pub fn munmap()` 方法

## 修改层次结构

```
系统调用接口层 (process.rs)
    ↓
全局任务管理层 (task/mod.rs)
    ↓
任务控制块层 (task/task.rs)
    ↓
内存管理层 (mm/memory_set.rs)
```

## 核心数据流

### mmap 调用流程
```
用户程序
  → sys_mmap(start, len, prot)        [process.rs]
  → mmap(start, len, prot)            [task/mod.rs]
  → TaskManager::mmap()               [task/mod.rs]
  → TaskControlBlock::mmap()          [task/task.rs]
  → MemorySet::mmap()                 [mm/memory_set.rs]
  → MapArea::new() + push()
```

### munmap 调用流程
```
用户程序
  → sys_munmap(start, len)            [process.rs]
  → munmap(start, len)                [task/mod.rs]
  → TaskManager::munmap()             [task/mod.rs]
  → TaskControlBlock::munmap()        [task/task.rs]
  → MemorySet::munmap()               [mm/memory_set.rs]
  → area.unmap() + remove
```

## 复制指南

按以下顺序复制文件到你的 rCore 项目:

```bash
# 1. 底层内存管理
cp memory_set.rs os/src/mm/memory_set.rs

# 2. 任务层
cp task.rs os/src/task/task.rs
cp task_mod.rs os/src/task/mod.rs

# 3. 系统调用层
cp process.rs os/src/syscall/process.rs
cp syscall_mod.rs os/src/syscall/mod.rs

# 4. 编译测试
cd os && make run
```
