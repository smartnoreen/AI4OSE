# 文件说明

本目录包含 rCore ch5 测试的关键修改文件。

## 文件列表

### 1. process.rs
**路径**: `os/src/syscall/process.rs`

**修改内容**:
- 实现 `sys_spawn(path: *const u8) -> isize`
- 实现 `sys_set_priority(prio: isize) -> isize`
- 实现 `sys_get_time(ts: *mut TimeVal, _tz: usize) -> isize`
- 实现 `sys_mmap(start: usize, len: usize, port: usize) -> isize`
- 实现 `sys_munmap(start: usize, len: usize) -> isize`

**关键函数**:
- `sys_spawn`: 直接从 ELF 数据创建新进程
- `sys_set_priority`: 设置当前进程优先级（最小值为 2）
- `sys_get_time`: 获取系统时间，写入用户空间
- `sys_mmap`: 创建内存映射，支持权限控制
- `sys_munmap`: 取消内存映射

### 2. task.rs
**路径**: `os/src/task/task.rs`

**修改内容**:
- 在 `TaskControlBlockInner` 中添加 `priority: usize` 字段
- 实现 `spawn(self: &Arc<Self>, elf_data: &[u8]) -> Arc<Self>` 方法
- 在 `new()`, `fork()`, `spawn()` 三处初始化 priority 字段

**关键实现**:
- spawn 方法创建新地址空间并加载 ELF
- priority 默认值为 16
- fork 时子进程继承父进程优先级

### 3. memory_set.rs
**路径**: `os/src/mm/memory_set.rs`

**修改内容**:
- 添加 `munmap_area(start_vpn: VirtPageNum, end_vpn: VirtPageNum) -> bool` 方法

**关键实现**:
- 精确匹配 MapArea 的起始和结束虚拟页号
- 成功时 unmap 并移除 area，返回 true
- 失败时返回 false

## 使用方法

将这些文件替换到对应的 rCore-Tutorial 源码位置：

```bash
# 复制到对应位置
cp process.rs os/src/syscall/process.rs
cp task.rs os/src/task/task.rs
cp memory_set.rs os/src/mm/memory_set.rs

# 重新编译
cd os
cargo build --release

# 运行测试
cd ../ci-user
make test CHAPTER=5
```

## 测试结果

- **通过率**: 14/15 (93.3%)
- **未通过**: ch4_unmap (Test 04_5)

## 技术亮点

1. **spawn vs fork**: spawn 直接加载新程序，无需复制地址空间
2. **优先级调度**: 动态优先级调整，支持继承
3. **内存映射**: 完整的 mmap/munmap 实现，包含权限和边界检查
4. **虚拟内存**: 正确使用 translated_refmut 处理用户空间指针
